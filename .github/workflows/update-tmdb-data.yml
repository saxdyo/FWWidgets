name: Update TMDB Trending Data

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00, 14:00, 20:00 æ›´æ–° (UTCæ—¶é—´)
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ•°æ®'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
      - name: Generate TMDB Data
        run: |
          echo "ğŸš€ å¼€å§‹ç”ŸæˆTMDBæ•°æ®..."
          node generate-standard-tmdb-data.js
          echo "âœ… æ•°æ®ç”Ÿæˆå®Œæˆ"
          
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/TMDB_Trending.json; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
          fi
          
      - name: Show data statistics
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "ğŸ“Š æ•°æ®æ–‡ä»¶ç»Ÿè®¡:"
          wc -l data/TMDB_Trending.json
          echo ""
          echo "ğŸ“… æ›´æ–°æ—¶é—´:"
          grep "last_updated" data/TMDB_Trending.json | head -1
          echo ""
          echo "ğŸ“ˆ æ•°æ®é¢„è§ˆ:"
          head -20 data/TMDB_Trending.json
          
      - name: Configure Git
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          # è·å–åŒ—äº¬æ—¶é—´
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          
          # æäº¤æ›´æ”¹
          git add data/TMDB_Trending.json
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°TMDBæ•°æ® - $BEIJING_TIME

          ğŸ“Š æ•°æ®æ›´æ–°å†…å®¹:
          - ä»Šæ—¥çƒ­é—¨å†…å®¹
          - æœ¬å‘¨çƒ­é—¨å†…å®¹  
          - çƒ­é—¨ç”µå½±åˆ—è¡¨
          
          ğŸ¤– ç”±GitHub Actionsè‡ªåŠ¨æ›´æ–°"
          
          # æ¨é€æ›´æ”¹
          git push origin main
          
          echo "âœ… æ•°æ®å·²æˆåŠŸæ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
          
      - name: No changes notification
        if: steps.check_changes.outputs.changes_detected == 'false'
        run: |
          echo "â„¹ï¸ æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          echo "å½“å‰æ•°æ®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµç¨‹å¤±è´¥ï¼Œæ­£åœ¨æ¸…ç†..."
          git reset --hard HEAD
          echo "ğŸ§¹ æ¸…ç†å®Œæˆ"