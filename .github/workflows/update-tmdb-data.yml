name: Update TMDB Trending Data

on:
  schedule:
    # 每天北京时间 8:00, 14:00, 20:00 更新 (UTC时间)
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: '强制更新数据'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
      - name: Generate TMDB Data
        run: |
          echo "🚀 开始生成TMDB数据..."
          node generate-standard-tmdb-data.js
          echo "✅ 数据生成完成"
          
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/TMDB_Trending.json; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "📋 没有检测到数据变化"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "📋 检测到数据变化"
          fi
          
      - name: Show data statistics
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "📊 数据文件统计:"
          wc -l data/TMDB_Trending.json
          echo ""
          echo "📅 更新时间:"
          grep "last_updated" data/TMDB_Trending.json | head -1
          echo ""
          echo "📈 数据预览:"
          head -20 data/TMDB_Trending.json
          
      - name: Configure Git
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          # 获取北京时间
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          
          # 提交更改
          git add data/TMDB_Trending.json
          git commit -m "🔄 自动更新TMDB数据 - $BEIJING_TIME

          📊 数据更新内容:
          - 今日热门内容
          - 本周热门内容  
          - 热门电影列表
          
          🤖 由GitHub Actions自动更新"
          
          # 推送更改
          git push origin main
          
          echo "✅ 数据已成功更新并推送到仓库"
          
      - name: No changes notification
        if: steps.check_changes.outputs.changes_detected == 'false'
        run: |
          echo "ℹ️ 数据没有变化，跳过提交"
          echo "当前数据已是最新版本"
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "❌ 工作流程失败，正在清理..."
          git reset --hard HEAD
          echo "🧹 清理完成"